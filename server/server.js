var BulletPool,Enemy,add_enemy,add_user_score,app,authenticate,bodyParser,calc_rank,check_bullet_hit,config,cookieParser,crs,e_shoot_cnt,e_upd_cnt,enemies,enemy_update_beh,express,find_nearest_user,gb_uname,gdis,grand,hash,io,online_players,path,player_max_score,process_bullet_hit,process_hit,prt,rand_data,restrict,server,session,sockets,sub_user_health,update_death_enemies,update_death_users,users,vec_trans,indexOf=[].indexOf||function(item){for(var i=0,l=this.length;i<l;i++){if(i in this&&this[i]===item)return i}return-1};express=require("express");app=express();path=require("path");server=require("http").Server(app);io=require("socket.io")(server);BulletPool=require("./BulletPool");Enemy=require("./Enemy");bodyParser=require("body-parser");cookieParser=require("cookie-parser");session=require("express-session");hash=require("./pass").hash;app.set("view engine","ejs");app.set("views",__dirname+"/views");app.use(bodyParser.urlencoded({extended:false}));app.use(session({resave:false,saveUninitialized:false,secret:"topsecret"}));app.use(function(req,res,next){var err,msg;err=req.session.error;msg=req.session.success;delete req.session.error;delete req.session.success;res.locals.message="";if(err){res.locals.message='<p class="msg error">'+err+"</p>"}if(msg){res.locals.message='<p class="msg success">'+msg+"</p>"}return next()});users={tj:{name:"tj"}};hash("foobar",function(err,salt,hash){if(err){throw err}users.tj.salt=salt;users.tj.hash=hash;return users.tj.score=10});authenticate=function(name,pass,fn){var user;if(!module.parent){console.log("authenticating %s:%s",name,pass)}user=users[name];if(!user){return fn(new Error("cannot find user"))}return hash(pass,user.salt,function(err,hash){if(err){return fn(err)}if(hash===user.hash){return fn(null,user)}return fn(new Error("invalid password"))})};restrict=function(req,res,next){if(req.session.user){return next()}else{req.session.error="Access denied!";return res.redirect("/login")}};app.get("/",function(req,res){return res.redirect("/login")});app.get("/index",restrict,function(req,res){return res.render("index")});app.get("/logout",function(req,res){return req.session.destroy(function(){return res.redirect("/")})});app.get("/login",function(req,res){return res.render("login")});gb_uname=null;app.post("/login",function(req,res){var uname;if(req.body.type==="Sign In"){return authenticate(req.body.username,req.body.password,function(err,user){var uname;if(user){return req.session.regenerate(function(){req.session.user=user;req.session.success="Authenticated as "+user.name+' click to <a href="/logout">logout</a>.';gb_uname=user.name;return res.redirect("./index")})}else{uname=req.body.username;if(indexOf.call(users,uname)>=0){req.session.error="User already exists ";return res.redirect("/index")}else{console.log("REGISTER");hash(req.body.password,function(err,salt,hash){if(err){throw err}return users[req.body.username]={name:req.body.username,salt:salt,hash:hash,score:10}});gb_uname=req.body.username;req.session.success="Registered as "+req.body.username;return res.redirect("/index")}}})}else{uname=req.body.username;if(indexOf.call(users,uname)>=0){req.session.error="User already exists ";return res.redirect("/login")}else{hash(req.body.password,function(err,salt,hash){if(err){throw err}return users[req.body.username]={name:req.body.username,salt:salt,hash:hash,score:10}});gb_uname=req.body.username;req.session.success="Registered as "+req.body.username;return res.redirect("/login")}}});prt=console.log;sockets={};online_players={};enemies=[];config={Enemy_Per_Player:3,Max_Enemies:2,SCORE_PER_HIT:1,HEALTH_PER_HIT:.05};app.use(express["static"](path.resolve(__dirname+"/../client")));app.use("/scripts",express["static"](path.resolve(__dirname+"/../node_modules/")));console.log(path.resolve(__dirname+"/../node_modules/"));gdis=function(x1,y1,x2,y2){return Math.sqrt((x1-x2)*(x1-x2)+(y1-y2)*(y1-y2))};grand=function(min,max){return Math.random()*(max-min)+min};find_nearest_user=function(e){var dis,id,mind,p,rp;mind=1e200;rp=null;for(id in online_players){p=online_players[id];dis=gdis(e.x,e.y,p.x,p.y);if(dis<mind){mind=dis;rp=p}}return rp};enemy_update_beh=function(e){var mouse,u;u=find_nearest_user(e);mouse={x:e.x,y:e.y,tar:false};if(u!=null){mouse.x=u.x;mouse.y=u.y;mouse.tar=true;mouse.tid=u.id;e.userUpdate(mouse.x,mouse.y)}return mouse};add_enemy=function(user){var e;if(enemies.length>=config.Max_Enemies){return}e=new Enemy(user);console.log("momentum "+e.momentum);return enemies.push(e)};rand_data=[];player_max_score={};calc_rank=function(){var res,score,uname;res=[];for(uname in player_max_score){score=player_max_score[uname];res.push({name:uname,score:score})}res.sort(function(_this){return function(a,b){return a.score-b.score}}(this));return res};app.get("/rank",restrict,function(req,res){return res.render("rank",{ranklist:calc_rank()})});io.on("connection",function(socket){var add_user_score,check_bullet_hit,crs,process_bullet_hit,process_hit,sub_user_health,update_death_enemies,update_death_users,user,vec_trans;console.log("new user");user={};user.id=socket.id;user.name=gb_uname;socket.emit("welcome",user);socket.on("validate",function(user_data){var i,k,p,pid,ref;user=user_data;sockets[user.id]=socket;online_players[user.id]=user_data;prt("validate user "+user.id);if(user.x!=null){prt("x "+user.x)}else{prt("x undefined")}if(user.y!=null){prt("y "+user.y)}else{prt("y undefined")}prt(Object.keys(online_players).length);for(pid in online_players){p=online_players[pid];prt(p.id)}io.emit("player_join",online_players);for(i=k=1,ref=config.Enemy_Per_Player;1<=ref?k<=ref:k>=ref;i=1<=ref?++k:--k){add_enemy(user)}});socket.on("disconnect",function(){prt("user "+user.id+" leave");delete online_players[user.id];prt(Object.keys(online_players).length);return socket.broadcast.emit("player_leave",online_players)});socket.on("restart_game",function(){return socket.emit("welcome",user)});add_user_score=function(_this){return function(usr){if(usr.score!=null){return usr.score+=config.SCORE_PER_HIT}}}(this);sub_user_health=function(_this){return function(usr){if(usr.health!=null){return usr.health-=config.HEALTH_PER_HIT}}}(this);vec_trans=function(_this){return function(angle,x,y){var p;p={x:x*Math.cos(angle)-y*Math.sin(angle),y:x*Math.sin(angle)+y*Math.cos(angle)};return p}}(this);crs=function(_this){return function(x1,y1,x2,y2){y1=-y1;y2=-y2;return x1*y2-x2*y1}}(this);check_bullet_hit=function(_this){return function(bullet,player){var angle,vec,x,x1,x2,x3,x4,y,y1,y2,y3,y4;x1=player.x;y1=player.y;x2=x1+player.width;y2=y1;x3=x2;y3=y2+player.height;x4=x1;y4=y3;angle=player.angle-Math.PI/2;vec=vec_trans(angle,x2-x1,y2-y1);x2=x1+vec.x;y2=y1+vec.y;vec=vec_trans(angle,x3-x1,y3-y1);x3=x1+vec.x;y3=y1+vec.y;vec=vec_trans(angle,x4-x1,y4-y1);x4=x1+vec.x;y4=y1+vec.y;x=bullet.x;y=bullet.y;return crs(x-x4,y-y4,x1-x4,y1-y4)>=0&&crs(x-x1,y-y1,x2-x1,y2-y1)>=0&&crs(x-x2,y-y2,x3-x2,y3-y2)>=0&&crs(x-x3,y-y3,x4-x3,y4-y3)>=0}}(this);process_bullet_hit=function(_this){return function(ua,ub){var a_bullet,b_bullet,k,l,len,len1,ref,ref1,results;ref=ub.bullet_pool.used_pool;for(k=0,len=ref.length;k<len;k++){b_bullet=ref[k];if(check_bullet_hit(b_bullet,ua)){add_user_score(ub);sub_user_health(ua)}}ref1=ua.bullet_pool.used_pool;results=[];for(l=0,len1=ref1.length;l<len1;l++){a_bullet=ref1[l];if(check_bullet_hit(a_bullet,ub)){console.log("there");add_user_score(ua);results.push(sub_user_health(ub))}else{results.push(void 0)}}return results}}(this);process_hit=function(_this){return function(cur_user){var enemy,k,len,results,u,uid;for(uid in online_players){u=online_players[uid];if(uid!==cur_user.id){process_bullet_hit(cur_user,u)}}results=[];for(k=0,len=enemies.length;k<len;k++){enemy=enemies[k];results.push(process_bullet_hit(cur_user,enemy))}return results}}(this);update_death_users=function(_this){return function(){var dead_usrs,k,len,results,u,uid;dead_usrs=[];for(uid in online_players){u=online_players[uid];if(u.health<=0){console.log("dead "+uid);sockets[uid].emit("death",u);dead_usrs.push(uid)}}results=[];for(k=0,len=dead_usrs.length;k<len;k++){uid=dead_usrs[k];results.push(delete online_players[uid])}return results}}(this);update_death_enemies=function(_this){return function(){var dead_enemies,e,eid,i,k,l,len,len1,results;dead_enemies=[];for(i=k=0,len=enemies.length;k<len;i=++k){e=enemies[i];if(e.health<=0){dead_enemies.push(i)}}results=[];for(l=0,len1=dead_enemies.length;l<len1;l++){eid=dead_enemies[l];results.push(enemies.split(eid,1))}return results}}(this);return socket.on("update",function(user_data){var u,uid;online_players[user_data.id]=user_data;return;process_hit(user_data);update_death_users();update_death_enemies();user_data=online_players[user_data.id];for(uid in online_players){u=online_players[uid];sockets[uid].emit("update_users",[online_players[uid],online_players])}})});e_upd_cnt=0;e_shoot_cnt=0;setInterval(function(){var e,i,j,k,l,len,len1,mouse,oe;if(enemies.length===0){return}for(i=k=0,len=enemies.length;k<len;i=++k){e=enemies[i];mouse=enemy_update_beh(e);if(e_shoot_cnt===0){e.shoot(e.x,e.y,e.angle)}e_shoot_cnt=(e_shoot_cnt+1)%5;for(j=l=0,len1=enemies.length;l<len1;j=++l){oe=enemies[j];if(j!==i){mouse.x+=1e3/gdis(e.x,e.y,oe.x,oe.y);mouse.y+=1e3/gdis(e.x,e.y,oe.x,oe.y)}}e.update(mouse)}io.emit("sync_enemies",enemies)},1e3/60);add_user_score=function(_this){return function(usr){if(usr.score!=null){return usr.score+=config.SCORE_PER_HIT}}}(this);sub_user_health=function(_this){return function(usr){if(usr.health!=null){return usr.health-=config.HEALTH_PER_HIT}}}(this);vec_trans=function(_this){return function(angle,x,y){var p;p={x:x*Math.cos(angle)-y*Math.sin(angle),y:x*Math.sin(angle)+y*Math.cos(angle)};return p}}(this);crs=function(_this){return function(x1,y1,x2,y2){y1=-y1;y2=-y2;return x1*y2-x2*y1}}(this);check_bullet_hit=function(_this){return function(bullet,player){var angle,vec,x,x1,x2,x3,x4,y,y1,y2,y3,y4;x1=player.x;y1=player.y;x2=x1+player.width;y2=y1;x3=x2;y3=y2+player.height;x4=x1;y4=y3;angle=player.angle-Math.PI/2;vec=vec_trans(angle,x2-x1,y2-y1);x2=x1+vec.x;y2=y1+vec.y;vec=vec_trans(angle,x3-x1,y3-y1);x3=x1+vec.x;y3=y1+vec.y;vec=vec_trans(angle,x4-x1,y4-y1);x4=x1+vec.x;y4=y1+vec.y;x=bullet.x;y=bullet.y;return crs(x-x4,y-y4,x1-x4,y1-y4)>=0&&crs(x-x1,y-y1,x2-x1,y2-y1)>=0&&crs(x-x2,y-y2,x3-x2,y3-y2)>=0&&crs(x-x3,y-y3,x4-x3,y4-y3)>=0}}(this);process_bullet_hit=function(_this){return function(ua,ub){var a_bullet,b_bullet,k,l,len,len1,ref,ref1,results;ref=ub.bullet_pool.used_pool;for(k=0,len=ref.length;k<len;k++){b_bullet=ref[k];if(check_bullet_hit(b_bullet,ua)){add_user_score(ub);sub_user_health(ua)}}ref1=ua.bullet_pool.used_pool;results=[];for(l=0,len1=ref1.length;l<len1;l++){a_bullet=ref1[l];if(check_bullet_hit(a_bullet,ub)){console.log("there "+ub.health);add_user_score(ua);sub_user_health(ub);results.push(console.log("after there "+ub.health+"\n"))}else{results.push(void 0)}}return results}}(this);process_hit=function(_this){return function(cur_user){var enemy,k,len,results,u,uid;for(uid in online_players){u=online_players[uid];if(uid!==cur_user.id){process_bullet_hit(cur_user,u)}}results=[];for(k=0,len=enemies.length;k<len;k++){enemy=enemies[k];results.push(process_bullet_hit(cur_user,enemy))}return results}}(this);update_death_users=function(_this){return function(){var dead_usrs,k,len,results,u,uid;dead_usrs=[];for(uid in online_players){u=online_players[uid];if(u.health<=0){console.log("dead "+uid);sockets[uid].emit("death",u);if(indexOf.call(player_max_score,uid)>=0){player_max_score[u.name]=Math.max(player_max_score[uid],u.score)}else{player_max_score[u.name]=u.score}dead_usrs.push(uid)}}results=[];for(k=0,len=dead_usrs.length;k<len;k++){uid=dead_usrs[k];results.push(delete online_players[uid])}return results}}(this);update_death_enemies=function(_this){return function(){var dead_enemies,e,eid,i,k,l,len,len1,results;dead_enemies=[];for(i=k=0,len=enemies.length;k<len;i=++k){e=enemies[i];if(e.health<=0){dead_enemies.push(i)}}results=[];for(l=0,len1=dead_enemies.length;l<len1;l++){eid=dead_enemies[l];results.push(enemies.split(eid,1))}return results}}(this);setInterval(function(){var u,uid,user_data;for(uid in online_players){u=online_players[uid];user_data=u;process_hit(user_data);update_death_users();update_death_enemies();user_data=online_players[user_data.id]}for(uid in online_players){u=online_players[uid];sockets[uid].emit("update_users",[online_players[uid],online_players])}},1e3/60);server.listen(3e3);